From 58b36ae0a8e50d581622bfeaf455ba2bebdf61d0 Mon Sep 17 00:00:00 2001
From: Renesas Electronics Corporation <someone@renesas.com>
Date: Tue, 21 Jun 2022 15:18:37 +0700
Subject: [PATCH 1/2] atf: bl31: transfer control to bl33 at EL2

---
 ...bl31-transfer-control-to-BL33-at-EL2.patch | 32 +++++++++++++++++++
 .../arm-trusted-firmware_git.bb               |  1 +
 2 files changed, 33 insertions(+)
 create mode 100755 meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware/0001-bl31-transfer-control-to-BL33-at-EL2.patch
 mode change 100644 => 100755 meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware_git.bb

diff --git a/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware/0001-bl31-transfer-control-to-BL33-at-EL2.patch b/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware/0001-bl31-transfer-control-to-BL33-at-EL2.patch
new file mode 100755
index 00000000..25de20b9
--- /dev/null
+++ b/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware/0001-bl31-transfer-control-to-BL33-at-EL2.patch
@@ -0,0 +1,32 @@
+From 26c4688d3d214ade84d1b29fabafb56a2db37e97 Mon Sep 17 00:00:00 2001
+From: Renesas Electronics Corporation <someone@renesas.com>
+Date: Tue, 21 Jun 2022 15:15:29 +0700
+Subject: [PATCH] bl31: transfer control to BL33 at EL2
+
+---
+ plat/renesas/rcar_gen4/bl31_plat_setup.c | 9 +++++++++
+ 1 file changed, 9 insertions(+)
+
+diff --git a/plat/renesas/rcar_gen4/bl31_plat_setup.c b/plat/renesas/rcar_gen4/bl31_plat_setup.c
+index 10698c83f..1b92f63a8 100644
+--- a/plat/renesas/rcar_gen4/bl31_plat_setup.c
++++ b/plat/renesas/rcar_gen4/bl31_plat_setup.c
+@@ -62,6 +62,15 @@ struct entry_point_info *bl31_plat_get_next_image_ep_info(uint32_t type)
+ 	next_image_info = (type == NON_SECURE) ?
+ 		&from_bl2->bl33_ep_info : &from_bl2->bl32_ep_info;
+ 
++	INFO("bl31_plat_get_next_image_ep_info(%s)\n \
++		  BL31: Original: SPSR = 0x%x \n", 
++			(type == NON_SECURE) ? "NON_SECURE" : "SECURE",
++			next_image_info->spsr);
++
++	if(type == NON_SECURE) {
++		from_bl2->bl33_ep_info.spsr = (uint32_t)SPSR_64(MODE_EL2, MODE_SP_ELX, DISABLE_ALL_EXCEPTIONS);
++	}
++
+ 	return (next_image_info->pc != 0U) ? next_image_info : NULL;
+ }
+ 
+-- 
+2.35.1
+
diff --git a/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware_git.bb b/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware_git.bb
old mode 100644
new mode 100755
index cb45e522..96b62751
--- a/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware_git.bb
+++ b/meta-rcar-gateway/recipes-bsp/arm-trusted-firmware/arm-trusted-firmware_git.bb
@@ -16,6 +16,7 @@ SRCREV = "5b0edfa45acfd8e14618cd324b62e49e33dcc40b"
 SRC_URI_append = "\
         file://0001-drivers-gicv3-Fix-setting-E-PPI-SGI-priorities.patch \
         file://0002-rcar_gen4-plat-BL31-Set-the-interrupt-priority-unifo.patch \
+        file://0001-bl31-transfer-control-to-BL33-at-EL2.patch \
 "
 
 PV = "v2.5+renesas+git${SRCPV}"
-- 
2.35.1

